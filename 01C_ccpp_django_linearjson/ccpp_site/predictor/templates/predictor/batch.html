{% extends "predictor/base.html" %}
{% block content %}
<div class="row g-4">
  <div class="col-lg-7">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Batch Prediction (CSV)</h5>
        <p class="text-muted mb-2">Upload a CSV with headers: <code>AT,V,AP,RH</code></p>
        <form method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="file" name="file" accept=".csv" class="form-control" required>
          <button class="btn btn-primary mt-3">Get Predictions</button>
          <a class="btn btn-outline-secondary mt-3 ms-2" href="/sample.csv">Download sample CSV</a>
        </form>

        {% if msg %}
          <div class="alert alert-warning mt-3">{{ msg }}</div>
        {% endif %}

        {% if download_href %}
          <a class="btn btn-success mt-3" download="{{ download_name }}" href="{{ download_href }}">
            Download Predictions CSV
          </a>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-lg-5">
    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="card-title">Notes</h6>
        {% if meta.metrics %}
          <div class="small mb-2">
            Current model — R²: <b>{{ meta.metrics.r2|floatformat:4 }}</b>,
            RMSE: <b>{{ meta.metrics.rmse|floatformat:3 }}</b> MW.
          </div>
        {% endif %}
        <div class="small text-muted">
          The output CSV includes a new column <code>PE_pred</code> with predictions in megawatts.
        </div>
      </div>
    </div>
  </div>
</div>

{% if charts_batch.pe_hist or charts_batch.pe_vs_at or charts_batch.pe_vs_v or charts_batch.pe_vs_ap or charts_batch.pe_vs_rh %}
  <hr class="my-4">
  <h5>Batch Charts</h5>

  <div class="row g-4 mt-1">
    {% if charts_batch.pe_hist %}
      <div class="col-lg-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <h6 class="card-title">Predicted PE Distribution</h6>
            <img class="img-fluid" src="data:image/png;base64,{{ charts_batch.pe_hist }}" alt="PE Histogram"/>
          </div>
        </div>
      </div>
    {% endif %}
    {% if charts_batch.pe_vs_at %}
      <div class="col-lg-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <h6 class="card-title">PE_pred vs AT</h6>
            <img class="img-fluid" src="data:image/png;base64,{{ charts_batch.pe_vs_at }}" alt="PE vs AT"/>
          </div>
        </div>
      </div>
    {% endif %}
    {% if charts_batch.pe_vs_v %}
      <div class="col-lg-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <h6 class="card-title">PE_pred vs V</h6>
            <img class="img-fluid" src="data:image/png;base64,{{ charts_batch.pe_vs_v }}" alt="PE vs V"/>
          </div>
        </div>
      </div>
    {% endif %}
  </div>

  <div class="row g-4 mt-1">
    {% if charts_batch.pe_vs_ap %}
      <div class="col-lg-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <h6 class="card-title">PE_pred vs AP</h6>
            <img class="img-fluid" src="data:image/png;base64,{{ charts_batch.pe_vs_ap }}" alt="PE vs AP"/>
          </div>
        </div>
      </div>
    {% endif %}
    {% if charts_batch.pe_vs_rh %}
      <div class="col-lg-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <h6 class="card-title">PE_pred vs RH</h6>
            <img class="img-fluid" src="data:image/png;base64,{{ charts_batch.pe_vs_rh }}" alt="PE vs RH"/>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
{% endif %}
{% endblock %}
